#!/usr/bin/env node

const program = require('commander')
const chalk = require('chalk')
const execa = require('execa')
const path = require('path')
const webpack = require('webpack')

const BuildProgress = require('../lib/buildProgress')

/**
 * Usage.
 */
program.usage('publish')

/**
 * Help
 */
program.on('--help', function () {
  console.log()
  console.log('  Examples:')
  console.log()
  console.log(chalk.gray('    # publish to the npmjs.org'))
  console.log(chalk.green('    $ timo publish'))
  console.log()
})

program.parse(process.argv)

// 获取项目路径
const absolutePath = execa.shellSync('pwd').stdout

// webpack config
// 生成环境配置
const prodConfigPath = path.join(absolutePath, 'webpack.config.js')
const prodConfig = require(prodConfigPath)

prodConfig.plugins.push(
  new BuildProgress()
)

const compilerProp = webpack(prodConfig)

compilerProp.run(() => {
  console.log(`\n${chalk.bgGreen.black(' SUCCESS ')} Production Compiled successfully.\n`)
})

// 压缩config
const ugConfigPath = path.join(absolutePath, 'webpack.config.min.js')
const ugConfig = require(ugConfigPath)

ugConfig.plugins.push(
  new BuildProgress()
)

const compilerUg = webpack(ugConfig)

compilerUg.run(() => {
  console.log(`\n${chalk.bgGreen.black(' SUCCESS ')} Uglify Compiled successfully.\n`)
})
